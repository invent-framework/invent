"""
An map widget, and related objects, for the Invent framework.

Based on original pre-COVID work by [Nicholas H.Tollervey.](https://ntoll.org/)

Copyright (c) 2019-present Invent contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
"""

from pyscript.web import div
from invent.i18n import _
from invent.utils import from_markdown
from invent.ui.core import (
    Widget,
    Event,
    FloatProperty,
    IntegerProperty,
    TextProperty,
    ListProperty,
    ChoiceProperty,
)
from pyscript import window
from pyscript.ffi import create_proxy


MARKER_ICON_DEFAULT = "default"
MARKER_ICON_AIRPORT = "airport"
MARKER_ICON_AMUSEMENTS = "amusements"
MARKER_ICON_BANK = "bank"
MARKER_ICON_SALON = "salon"
MARKER_ICON_BOOKS = "books"
MARKER_ICON_BUS_STOP = "bus_stop"
MARKER_ICON_CAFE = "cafe"
MARKER_ICON_CAMPING = "camping"
MARKER_ICON_CAR_HIRE = "car_hire"
MARKER_ICON_CAR_REPAIR = "car_repair"
MARKER_ICON_CONVENIENCE_STORE = "convenience_store"
MARKER_ICON_CROSSHAIRS = "crosshairs"
MARKER_ICON_DENTIST = "dentist"
MARKER_ICON_DOCTOR = "doctor"
MARKER_ICON_ELECTRICAL = "electrical"
MARKER_ICON_FLAG = "flag"
MARKER_ICON_FIRE_STATION = "fire_station"
MARKER_ICON_FLOWER = "flower"
MARKER_ICON_FAST_FOOD = "fast_food"
MARKER_ICON_FUEL = "fuel"
MARKER_ICON_HOSPITAL = "hospital"
MARKER_ICON_LAUNDRY = "laundry"
MARKER_ICON_LAW = "law"
MARKER_ICON_HOTEL = "hotel"
MARKER_ICON_MOVIE = "movie"
MARKER_ICON_MUSEUM = "museum"
MARKER_ICON_NIGHTCLUB = "nightclub"
MARKER_ICON_PICNIC = "picnic"
MARKER_ICON_PARKING = "parking"
MARKER_ICON_PHARMACY = "pharmacy"
MARKER_ICON_PHOTO = "photo"
MARKER_ICON_PLACE_OF_WORSHIP = "place_of_worship"
MARKER_ICON_POLICE = "police"
MARKER_ICON_POST_OFFICE = "post_office"
MARKER_ICON_RESTAURANT = "restaurant"
MARKER_ICON_SAILING = "sailing"
MARKER_ICON_SPORTS = "sports"
MARKER_ICON_SUBWAY = "subway"
MARKER_ICON_TAXI = "taxi"
MARKER_ICON_TOILET = "toilet"
MARKER_ICON_TRAIN = "train"
MARKER_ICON_TRANSIT_STATION = "transit_station"
MARKER_ICON_UNIVERSITY = "university"
MARKER_ICON_VET = "vet"
MARKER_ICON_WHEELCHAIR = "wheelchair"
MARKER_ICON_ZOO = "zoo"

# Marker icons from: https://icon-sets.iconify.design/map/ (Open Font License) by Scott de Jonge (https://github.com/scottdejonge/map-icons)
MARKER_ICONS = {
    MARKER_ICON_DEFAULT: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M25 0c-8.284 0-15 6.656-15 14.866s15 35.135 15 35.135s15-26.924 15-35.135S33.284 0 25 0m-.049 19.312c-2.557 0-4.629-2.055-4.629-4.588c0-2.535 2.072-4.589 4.629-4.589c2.559 0 4.631 2.054 4.631 4.589c0 2.533-2.072 4.588-4.631 4.588'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_AIRPORT: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M48.049 36.31c.523.169.951-.142.951-.692v-3.494c0-.55-.387-1.23-.859-1.512L29.859 19.717c-.472-.281-.859-.962-.859-1.511V6c0-.55-.168-1.417-.374-1.928c0 0-1.091-2.708-3-3.01A3.6 3.6 0 0 0 25.007 1h-.01a3.7 3.7 0 0 0-.713.072l-.216.048l-.328.102c-1.588.53-2.406 2.835-2.406 2.835A7 7 0 0 0 21 6v12.206c0 .55-.387 1.23-.859 1.512L1.859 30.612c-.472.282-.859.962-.859 1.512v3.494c0 .55.428.861.951.691l18.098-5.875c.523-.169.951.142.951.692v9.533c0 .55-.36 1.271-.8 1.601l-2.4 1.802c-.44.33-.8 1.051-.8 1.601V48c0 .55.433.876.961.724l6.075-1.745c.528-.152 1.394-.152 1.922 0l6.081 1.745c.528.152.961-.174.961-.724v-2.338c0-.55-.36-1.271-.8-1.601l-2.4-1.802c-.439-.33-.8-1.051-.8-1.601v-9.533c0-.55.428-.861.951-.691z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_AMUSEMENTS: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M39.922 28.087c.463.227 1.027.223 1.253-.011c.229-.233.031-.601-.438-.817l-8.178-3.788c-.469-.218-1.257-.273-1.749-.125l-2.925.877c-.497.149-1.145.271-1.439.271s-.539-.414-.539-.922v-8.919c0-.507.423-.923.941-.923h21.209c.52 0 .942-.415.942-.923V9.812c0-.508-.407-1.042-.902-1.187L25.762 2.108c-.495-.145-1.307-.145-1.802.002L1.899 8.624C1.405 8.769 1 9.305 1 9.812v2.994c0 .508.423.923.94.923h20.93c.518 0 .941.416.941.923v8.924a.936.936 0 0 1-.941.924h-.38c-.518.001-1.244-.289-1.616-.643l-5.046-4.819c-.373-.355-1.099-.644-1.617-.644h-2.334c-.516 0-1.139-.305-1.382-.676c-.241-.372-.803-.674-1.248-.674s-.582.348-.302.776l.044.067c.28.427.281 1.13.006 1.559L6.471 23.37a1.13 1.13 0 0 0 .196 1.402l.179.161c.385.34 1.071.428 1.53.191l2.704-1.407c.46-.238 1.061-.083 1.34.344l2.967 4.542a1.07 1.07 0 0 1-.208 1.376l-1.357 1.133c-.395.328-.625 1.001-.511 1.498l1.759 7.652c.114.497.619.8 1.121.675l1.223-.302a.96.96 0 0 0 .709-1.128l-1.191-5.175a.98.98 0 0 1 .702-1.146l3.007-.806a8.6 8.6 0 0 1 1.849-.241h.38c.518 0 .941.415.941.92v9.177a.934.934 0 0 1-.941.921H1.94a.934.934 0 0 0-.94.924v2.992c0 .513.423.927.94.927h45.728c.518 0 .94-.414.94-.925v-2.992a.934.934 0 0 0-.94-.924H26.849a.933.933 0 0 1-.941-.921v-9.177c0-.505.423-.92.941-.92h1.084c.518 0 1.345.107 1.848.241l3.007.806c.502.133.818.65.702 1.146l-1.188 5.175a.953.953 0 0 0 .705 1.128l1.225.302a.915.915 0 0 0 1.12-.675l1.761-7.652c.117-.497-.105-1.16-.488-1.482c-.382-.318-.719-.996-.749-1.502l-.153-2.707c-.031-.506.326-.735.79-.507z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_BANK: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M34.682 25.801q-2.157-1.701-6.474-2.717L26 22.563v-9.43l.299.122C28.173 14.204 29.18 16 29.318 18h7.516c-.137-4-1.615-6.958-4.434-9.048C30.527 7.563 28.391 6.67 26 6.22V1h-7v5.06c-3.237.4-5.804 1.442-7.689 3.136Q7.609 12.523 7.61 17.55q0 5.51 3.783 8.1c1.412.979 3.957 1.888 7.607 2.73v10.216c-1.331-.367-2.374-.971-3.109-1.844c-.709-.848-1.184-1.752-1.426-3.752H7c0 4 1.411 6.87 4.234 9.096c2.038 1.606 4.632 2.582 7.766 3.005V49h7v-3.833c3.333-.399 6.024-1.463 8.062-3.204q3.965-3.39 3.965-8.519q0-5.002-3.345-7.643m-18.014-5.817q-1.822-.991-1.822-3c0-1.456.616-2.597 1.848-3.409c.65-.429 1.424-.741 2.306-.947v8.224c-1.085-.316-1.868-.606-2.332-.868m10.475 18.407a10 10 0 0 1-1.143.306V30q1.809.536 2.848 1.164c1.092.677 1.639 1.64 1.639 2.875c-.001 2.116-1.116 3.573-3.344 4.352'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_SALON: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M34.781 6.664H27.83c-1.256.004-1.209 1.876 0 1.865h6.951v.957H27.83c-1.249-.011-1.203 1.86 0 1.865h6.951v.978H27.83c-1.249 0-1.203 1.87 0 1.865h6.951v.932H27.83c-1.223.009-1.203 1.881 0 1.887h6.951v.934H27.83c-1.223-.004-1.228 1.865 0 1.865h6.951v.932H27.83c-1.223.004-1.228 1.875 0 1.866h6.951v.955H27.83c-1.223-.011-1.228 1.858 0 1.865h6.951v.93H27.83c-1.223-.001-1.203 1.872 0 1.866h6.951v18.159c.004 2.767 4.207 2.717 4.219 0V3.89c-.012-1.264-1.05-2.862-2.758-2.867H27.83c-1.256.001-1.209 1.873 0 1.865l6.951.023v.93H27.83c-1.254-.006-1.207 1.865 0 1.866h6.951zm-7.429 32.194C27.348 35.628 24 32.154 20 34.404V22.05L17.413 1.675c-.054-.539-.511-.666-.818-.675c-.317.009-.952.136-1.021.675L13 22.05v12.354c-4-2.25-7.24 1.246-7.241 4.429c.001 2.832 2.181 5.158 5.131 5.151c2.972.007 5.11-2.6 5.11-5.151V26h1v12.833c0 2.856 2.212 4.97 4.67 5.104c-.041 1.566.47 3.8 1.432 4.686c1.128 1.04 2.471-.29 1.92-1.373c-.532-1.008-1.054-1.605-.63-3.806c1.772-.82 2.956-2.546 2.96-4.586m-16.348 2.541a2.542 2.542 0 0 1 0-5.085c1.386.008 2.515 1.145 2.525 2.544a2.55 2.55 0 0 1-2.525 2.541m8.571-2.541a2.553 2.553 0 0 1 2.526-2.544a2.55 2.55 0 0 1 2.525 2.544a2.545 2.545 0 0 1-2.525 2.541a2.55 2.55 0 0 1-2.526-2.541'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_BOOKS: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M41 40V6c0-2.2-1.8-4-4-4H13c-2.2 0-4 1.8-4 4v38c0 2.2 1.8 4 4 4h24c1.858 0 4 0 4-2v-1H14c-1.1 0-2-.9-2-2v-3zM14 10c0-.55.45-1 1-1h20c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1H15c-.55 0-1-.45-1-1zm0 8c0-.55.45-1 1-1h20c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1H15c-.55 0-1-.45-1-1z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_BUS_STOP: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M41.162 25H9.142c-.933 0-1.701-.802-1.701-1.714c0-.152.028-.324.059-.462l1.704-11.899c.145-.773.841-.925 1.674-.925h28.553c.827 0 1.529.139 1.672.909l1.704 12.116c.026.141.06.224.06.376c-.001.912-.773 1.599-1.705 1.599m-1.281 13.345c-1.803 0-3.265-1.419-3.265-3.188c0-1.757 1.462-3.174 3.265-3.174c1.791 0 3.256 1.417 3.256 3.174c0 1.769-1.465 3.188-3.256 3.188m-29.501 0c-1.79 0-3.253-1.419-3.253-3.188c0-1.757 1.463-3.174 3.253-3.174c1.808 0 3.268 1.417 3.268 3.174c0 1.769-1.46 3.188-3.268 3.188M16 3h20v3H16c-2 0-2-3 0-3m28.202 4.59c-.584-2.813-2.29-3.946-5.073-5.078c-2.778-1.128-9.216-2.48-14.058-2.48c-4.863 0-11.334 1.353-14.115 2.48c-2.782 1.133-4.46 2.265-5.039 5.078L4 23.249V45h3v2c0 4 5 4 5 0v-2h25v2c0 4 6 4 6 0v-2h3V23.249z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_CAFE: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M37 7H9v27c0 2.2 1.8 4 4 4h20c2.2 0 4-1.8 4-4v-5c6.076 0 11-4.925 11-11S43.076 7 37 7m0 17V12a6 6 0 1 1 0 12M2 40v2.301C2 44.197 4.069 45 6.6 45h36.8c2.53 0 4.6-.803 4.6-2.699V40z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_CAMPING: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M25 6c-1.263 0-1.834.616-2.21 1.286L7.08 36.858H3.685C2.203 36.858 1 38.003 1 39.429c0 1.423 1.203 2.57 2.685 2.57h42.632c1.481 0 2.685-1.147 2.685-2.57c0-1.427-1.203-2.571-2.685-2.571H42.92L27.211 7.285C26.834 6.616 26.264 6 25 6m0 12.857l8.842 18.001H16.158z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_CAR_HIRE: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M41 4H22.077C20.574 2 18.111.248 15.325.248c-4.577 0-8.287 3.576-8.287 8.153c0 4.578 3.71 8.037 8.287 8.037c3.481 0 6.459-2.438 7.688-5.438h2.755l1.997-1.998L29.761 11h1.245l1.996-1.998L34.999 11h1.244l1.997-1.998L40.237 11H41v.281l-.174.041l3.94-3.862zm-28.357 6.61a2.4 2.4 0 1 1 .003-4.801a2.4 2.4 0 0 1-.003 4.801M43 30h-.553l-6.144-11.125c-.265-.481-.933-.875-1.483-.875H16.18c-.55 0-1.218.394-1.483.875L8.552 30H8c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h2v3c0 1.65 1.35 3 3 3h1c1.65 0 3-1.35 3-3v-3h17v3c0 1.65 1.35 3 3 3h1c1.65 0 3-1.35 3-3v-3h2c1.1 0 2-.9 2-2V32c0-1.1-.9-2-2-2m-31.5 8a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5m2-8l4.053-8.105C17.799 21.402 18.45 21 19 21h13c.55 0 1.201.402 1.447.895L37.5 30zm26 8a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_CAR_REPAIR: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M21.434 7.689L19 11h-5.684c.701 2 2.996 3.886 6.201 3.26c.95-.064 4.155-.573 5.483-.26c1.768.424 1.031.426 4.201 2.97L45 30c.968.855 2.206.505 3.063-.461c.857-.968.905-2.684-.063-3.539L28 10c-1.252-1.005-1.568-2.397-2-4c-.84-2.755-3.929-4.965-6.961-4.965C16.596 1.035 13.967 3.148 13 5h6zM35.154 32l-6.182-10.73c-.244-.445-.861-1.27-1.368-1.27H10.396c-.507 0-1.124.825-1.369 1.27L3 32h-.154C1.831 32 1 32.369 1 33.385v9.23C1 43.631 1.831 44 2.846 44H5v3.23C5 48.754 5.938 50 7.461 50h.923C9.908 50 11 48.754 11 47.23V44h16v3.23c0 1.523 1.092 2.77 2.615 2.77h.923C32.062 50 33 48.754 33 47.23V44h2.154C36.169 44 37 43.631 37 42.615v-9.23C37 32.369 36.169 32 35.154 32M6.077 38.923a2.308 2.308 0 1 1 0-4.615a2.308 2.308 0 0 1 0 4.615M7.923 32l3.741-7.828C11.891 23.718 12.493 23 13 23h12c.507 0 1.108.718 1.336 1.172L30.077 32zm24 6.923a2.308 2.308 0 1 1 0-4.616a2.308 2.308 0 0 1 0 4.616'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_CONVENIENCE_STORE: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M41 19h-.272a2 2 0 0 0-.266-.365L28.918 6.267c.051-.247.082-.503.082-.767C29 3.567 27.576 2 25.818 2h-3.637C20.424 2 19 3.567 19 5.5c0 .264.032.52.082.767L7.538 18.635a2 2 0 0 0-.266.365H2v7h2v15a5 5 0 0 0 5 5h32a5 5 0 0 0 5-5V26h2v-7zM22.182 9h3.637l.163-.018L35.331 19H12.669l9.35-10.018zM13 40c0 1.1-.9 2-2 2s-2-.9-2-2V28c0-1.1.9-2 2-2s2 .9 2 2zm9 0c0 1.1-.9 2-2 2s-2-.9-2-2V28c0-1.1.9-2 2-2s2 .9 2 2zm10 0c0 1.1-.9 2-2 2s-2-.9-2-2V28c0-1.1.9-2 2-2s2 .9 2 2zm9 0c0 1.1-.9 2-2 2s-2-.9-2-2V28c0-1.1.9-2 2-2s2 .9 2 2z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_CROSSHAIRS: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M25 1C11.766 1 1 11.766 1 25s10.766 24 24 24s24-10.767 24-24S38.233 1 25 1m3 43.75V36h-6v8.75C13.375 43.443 6.557 36.625 5.25 28H14v-6H5.25C6.557 13.375 13.375 6.557 22 5.25V14h6V5.25C36.625 6.557 43.443 13.375 44.75 22H36v6h8.75C43.443 36.625 36.625 43.443 28 44.75'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_DENTIST: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M24.847 27.268c3.547 0 5.191 2.69 5.536 6.512c.081.914-.001 2.247-.12 3.791C29.865 42.699 29.407 49 32.82 49c2.89 0 4.371-5.54 5.229-11.856c.826-6.252-.051-9.363.382-12.14c.821-5.26 5.412-9.976 3.994-16.683c-.786-3.721-2.836-5.47-4.864-6.207c-4.674-1.701-7.694 1.577-12.714 1.577c-5.019 0-8.037-3.278-12.713-1.577c-2.027.736-4.078 2.486-4.866 6.207c-1.415 6.707 3.175 11.422 3.999 16.683c.429 2.776-.443 5.888.382 12.14C12.505 43.46 13.989 49 16.876 49c3.411 0 2.956-6.301 2.558-11.429c-.116-1.545-.204-2.878-.121-3.792c.344-3.821 2.012-6.511 5.534-6.511'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_DOCTOR: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M42.924 13H38V7.774C38 4.038 35.052 1 31.306 1H18.695C14.947 1 12 4.038 12 7.774V13H7.075C3.719 13 1 15.591 1 18.937v23.007C1 45.289 3.719 48 7.075 48h35.849C46.279 48 49 45.289 49 41.943V18.937C49 15.591 46.279 13 42.924 13M16 7.774C16 6.375 17.292 5 18.695 5h12.611C32.705 5 34 6.375 34 7.774V13H16zM36 35h-7v7h-8v-7h-7v-8h7v-7h8v7h7z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_ELECTRICAL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M41 14h-5V2.919C36 1.859 35.105 1 34 1s-2 .859-2 1.919V14H16V2.919C16 1.859 15.105 1 13.999 1S12 1.859 12 2.919V14H7c-.553 0-1 .869-1 1.399V20.2c0 5.759 10 12.446 10 21.696V45h4v4h8v-4h4v-3.104c0-9.25 10-15.938 10-21.696v-4.801c0-.53-.447-1.399-1-1.399M22.907 30.388c.065-.21-.067-.388-.296-.388h-3.885c-.23 0-.295-.13-.149-.299c0 0 8.005-10.159 8.161-10.355c.118-.186.248-.121.207.093c-.062.271-1.771 7.202-1.771 7.202c-.083.204.037.359.264.359h3.887c.229 0 .302.154.162.328c0 0-8.017 10.402-8.161 10.576s-.279.121-.206-.175z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_FLAG: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M11.462 1C10.099 1 9 2.127 9 3.526v42.946c0 1.262 1.231 2.527 2.462 2.527c1.23 0 2.461-1.266 2.461-2.527V20.578c.841-.367 1.659-.632 2.462-.632c4.923 0 12.185 6.317 17.231 6.317c2.151 0 5.231-.871 7.384-2.527V6.052c-2.442 1.879-4.916 3.79-7.384 3.79c-4.923 0-12.291-6.316-17.231-6.316c-.83 0-1.64.152-2.462.316v-.316C13.923 2.127 12.824 1 11.462 1'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_FIRE_STATION: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M25.335 24.297s-4.839 3.893-4.839 7.04c0 1.409 2.074 2.817 4.839 2.817c2.763 0 4.837-1.408 4.837-2.817c0-3.26-4.837-7.04-4.837-7.04m17.641-7.116c.28-3.428 1.274-6.575 3.024-9.459L39.281 1c-2.122 1.828-4.54 2.84-7.28 3.019c-2.51.227-4.889-.25-7.126-1.435c-2.302 1.146-4.672 1.625-7.143 1.435c-2.555-.229-4.862-1.135-6.927-2.741L4.067 7.997c1.657 2.926 2.58 5.987 2.761 9.184c.086 1.472-.334 3.497-1.276 6.117a45 45 0 0 0-1.12 3.764c-.236 1.045-.383 1.895-.431 2.531c-.035 2.79.748 5.311 2.353 7.55c1.254 1.635 3.322 3.441 6.194 5.415c3.143 1.6 5.574 2.638 7.277 3.082l1.412.656c.445.212.921.42 1.417.647c1.071.641 1.823 1.337 2.221 2.056c.485-.777 1.254-1.456 2.278-2.056a50 50 0 0 0 1.822-.828l1.066-.476c.364-.181.843-.388 1.419-.616a85 85 0 0 1 2.16-.821c1.659-.587 2.869-1.143 3.635-1.645c2.786-1.974 4.823-3.75 6.118-5.34c1.663-2.248 2.47-4.779 2.433-7.625c-.099-1.274-.638-3.313-1.617-6.09c-.933-2.705-1.347-4.805-1.213-6.321M25.335 36.97c-6.107 0-11.75-5.044-11.75-11.265c0-4.225 3.23-8.216 4.147-9.857l2.764 4.225l4.839-7.04l4.837 7.04l2.768-4.225c.914 1.641 4.147 5.632 4.147 9.857c0 6.221-5.644 11.265-11.752 11.265'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_FLOWER: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cellipse cx='25.015' cy='25.003' fill='none' rx='2.674' ry='2.688'/%3E%3Cpath fill='{icon_color}' d='M25.554 36.172c3.601 16.811 23.919 3.049 3.74-8.661c22.24 12.908 22.293-17.916.045-5.018c22.248-12.897-4.317-28.315-4.322-2.509c.005-25.806-26.564-10.4-4.327 2.509c-22.237-12.91-22.263 17.915-.019 5.016c-20.19 11.704.082 25.482 3.684 8.637zm-3.213-11.169a2.68 2.68 0 0 1 2.674-2.688a2.68 2.68 0 0 1 2.673 2.688a2.68 2.68 0 0 1-2.673 2.688a2.683 2.683 0 0 1-2.674-2.688'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_FAST_FOOD: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M48.894 15.154L44.959 46H31.668l-3.919-31h16.226l3.207-11.077L49 4.471l-3.077 10.66zM25.87 33s.497-4-6.395-4H8.499c-6.882 0-6.395 4-6.395 4zM2.104 42s-.487 4 6.395 4h10.977c6.892 0 6.395-4 6.395-4zm22.735-2c1.128 0 2.039-1.114 2.039-2.499c0-1.393-.911-2.501-2.039-2.501H3.04C1.917 35 1 36.108 1 37.501C1 38.886 1.917 40 3.04 40z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_FUEL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M45.102 10.08c.549-.549 1.322-1.146 2.111-1.866l.729-.611l-1.987-2.23l-.649.607c-2.746 2.495-4.398 4.003-5.205 7.094c-.801 3.073-.833 6.184-.749 9.092c.088 2.998.201 4.976 1.039 7.182l.316.813c.804 2.023 2.021 5.079 2.021 9.01c0 4.749-1.924 7.158-5.718 7.158c-3.452 0-5.314-2.304-5.532-6.856c-.099-2.017.467-4.507 1.062-7.138c.503-2.221 1.021-4.519 1.276-6.958c.282-2.689-.071-4.611-1.104-5.765C31.386 18.131 29.345 18 27.547 18H27V4.139C27 2.939 26.129 2 24.936 2H4.295C3.104 2 2 2.939 2 4.139V48h25V21h.548c1.23 0 2.504.138 2.937.621c.232.26.588 1.102.353 3.373c-.237 2.264-.739 4.503-1.223 6.636c-.641 2.839-1.249 5.539-1.129 7.973c.295 6.179 3.404 9.73 8.524 9.73c5.457 0 8.715-3.798 8.715-10.168c0-4.509-1.395-8.022-2.232-10.127l-.302-.767c-.602-1.589-.737-3.062-.82-5.632c.963-.022 2.129-.045 2.653-.045c1.199 0 1.802-.703 2.059-1.921c.15-.71-.082-1.641-.082-3.331v-.448c-.001-4.467-.684-5.743-1.899-6.814M24 19H5V6h19zm20-1.654c0 .873.23 1.708.201 2.239c-.598.009-1.286.025-1.986.041c.026-1.929.24-3.893.733-5.784c.134-.504.094-.948.296-1.362c.533.513.756 1.282.756 4.416z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_HOSPITAL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M37 1c-.55 0-1 .45-1 1v14c0 .55-.45 1-1 1H15c-.55 0-1-.45-1-1V2c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v46c0 .55.45 1 1 1h9c.55 0 1-.45 1-1V32c0-.55.45-1 1-1h20c.55 0 1 .45 1 1v16c0 .55.45 1 1 1h9c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_LAUNDRY: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M6 11v33.74C6 46.21 7.237 48 8.76 48h33.218C43.497 48 45 46.21 45 44.74V11zm19.46 26.776c-5.86 0-10.611-4.594-10.611-10.263S19.6 17.25 25.46 17.25s10.611 4.594 10.611 10.263c0 5.67-4.751 10.263-10.611 10.263M41.978 1H8.76C7.237 1 6 2.033 6 3.505V9h39V3.505C45 2.033 43.497 1 41.978 1M19 7H8V3h11zm19.146-.28c-1.249 0-2.258-.979-2.258-2.188c0-1.207 1.009-2.186 2.258-2.186s2.261.979 2.261 2.186c-.001 1.208-1.012 2.188-2.261 2.188'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_LAW: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M.295 27.581a6.457 6.457 0 0 0 12.805 0zM35.182 40.58a1 1 0 0 1-.998 1.003H15.528c-.548 0-1-.45-1-1.003a1 1 0 0 1 1-.993h18.655c.552 0 .999.444.999.993m-20.545 1.514h20.437v2.887H14.637zM36.9 27.581a6.46 6.46 0 0 0 6.402 5.626a6.45 6.45 0 0 0 6.399-5.626zm12.449-2.009l-5.243-7.222h2.803c.682 0 1.231-.559 1.231-1.25c0-.685-.55-1.238-1.231-1.238H32.061a7.35 7.35 0 0 0-5.634-4.732V7.233c0-.693-.556-1.246-1.245-1.246L25.066 6l-.116-.013a1.24 1.24 0 0 0-1.243 1.246v3.895a7.35 7.35 0 0 0-5.632 4.732H3.224c-.677 0-1.229.553-1.229 1.238c0 .692.552 1.25 1.229 1.25h2.675L.655 25.57H0v1.334h13.398V25.57h-.658l-5.242-7.22h12.169c0-.282.031-.559.073-.824c.043-.125.072-.252.072-.383a5.32 5.32 0 0 1 3.895-3.933v13.697h-.052c-.107 5.152-2.558 9.645-6.194 12.17h15.214c-3.637-2.525-6.086-7.018-6.199-12.17h-.048V13.21a5.32 5.32 0 0 1 3.894 3.933q.008.196.075.383c.04.266.065.542.065.824h12.042l-5.244 7.222h-.654v1.334H50v-1.334zm-43.184 0H1.98l4.185-5.765zm1.071 0v-5.765l4.185 5.765zm35.532 0h-4.187l4.187-5.765zm1.066 0v-5.765l4.19 5.765zM7.941 14.124a1.243 1.243 0 0 1-2.485 0c0-.686.558-1.246 1.245-1.246c.684-.001 1.24.56 1.24 1.246m36.604-.066c0 .691-.556 1.239-1.242 1.239a1.234 1.234 0 0 1-1.242-1.239a1.243 1.243 0 1 1 2.484 0'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_HOTEL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M46 32v8h4V28H4V11.66c0-1.123-.869-2.042-2-2.042c-1.127 0-2 .918-2 2.042V40h4v-8zM10.33 19.852a3.687 3.687 0 0 0 3.687-3.694a3.68 3.68 0 0 0-3.687-3.675a3.68 3.68 0 0 0-3.683 3.675a3.686 3.686 0 0 0 3.683 3.694M50 25l-.014-4.871c-.013-1.606-1.36-2.618-2.939-2.809L18.09 14.487l-.215-.009c-1.006 0-1.875.834-1.875 1.835V22H8.547c-1.011 0-1.826.5-1.826 1.499c0 1.015.815 1.501 1.826 1.501z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_MOVIE: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M42.215 13h-5.674l5.709-5.474L36.602 2h-7.994l5.727 5.473L28.464 13h-6.789l5.838-5.474L21.746 2h-8.131l5.727 5.473L13.463 13H7.709l5.841-5.474L7.772 2H2v46h46V2h-5.642L48 7.504zM42 42H8v-6h34zm0-11H8v-6h34z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_MUSEUM: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M9.27 19h3.916l.602 18H8.749zM6 38h38v2h3v3h2v2H1v-2h2v-3h3zm40-24.188L25.002 5L4 13.812V15h42zM8 16h34v2H8zm28.736 3h3.914l.607 18h-5.046zm-9.152 0h3.914l.6 18h-5.041zm-9.154 0h3.915l.596 18h-5.039z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_NIGHTCLUB: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M47 9H32s-1 8 1 16c.804 1.34 2.79 2.062 5 2.245V37h-.333L34 40h11l-3.584-3H41v-9.828c2.12-.275 4.063-1.014 5-2.172c2-7 1-16 1-16m-1 6H33v-5h13zM21.5 37H16v-8.5L27 12H1l11 16.5V37H6.5a1.5 1.5 0 1 0 0 3h15a1.5 1.5 0 1 0 0-3'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_PICNIC: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M17.1 26h14.87l-4.893-13h-5.073zM9 13V9h32v4h-7.871l4.905 13H50v4H39.863l5.729 14h-5.559l-5.728-14H15.782L10.08 44H4.52l5.697-14H0v-4h12.042l4.901-13z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_PARKING: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M29.617 0H7v50h11V34h11.617c12.464 0 17.294-9.871 17.294-18.02C46.911 7.873 42.081 0 29.617 0m-3.013 24H18V9h8.604c5.113 0 9.668 1.128 9.668 7.487C36.271 22.885 31.717 24 26.604 24'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_PHARMACY: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M39.352 17H10.4C5.23 17 1 20.64 1 25.5S5.23 34 10.4 34h28.952c5.168 0 9.398-3.641 9.398-8.5c0-4.86-4.23-8.5-9.398-8.5m.003 15H25V19h14.355c3.812 0 6.934 2.915 6.934 6.5S43.168 32 39.355 32'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_PHOTO: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M31 25.002A5.999 5.999 0 0 0 31 37a6 6 0 0 0 0-11.998m12.001-12.005L38.06 3.03A2.99 2.99 0 0 0 35.221 1H26.98a2.99 2.99 0 0 0-2.854 2.075L19.007 13H6.999A6.004 6.004 0 0 0 1 19.001V49h48V19.001a6.005 6.005 0 0 0-5.999-6.004M10 25.002a3 3 0 0 1-3.001-2.998c0-1.662 1.342-3.003 3.001-3.003s2.999 1.341 2.999 3.003A2.996 2.996 0 0 1 10 25.002m21 18.004c-6.625 0-12.001-5.377-12.001-12.006c0-6.626 5.375-11.999 12.001-11.999S43.001 24.373 43.001 31c0 6.629-5.375 12.006-12.001 12.006'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_PLACE_OF_WORSHIP: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M43.28 13.896L24.958 1l-4.125 2.908l.062.048L4.76 15.426L1 18.033v6.103l3.839-2.587V49h40.323V21.304L49 24.136v-6.103zM39.4 43.152H9.96V17.858L25.017 7.019L39.4 17.37zM18.235 20.766c1.072 0 1.958-.883 1.958-1.987c0-1.102-.886-1.994-1.958-1.994c-1.085 0-1.963.893-1.963 1.994a1.97 1.97 0 0 0 1.963 1.987m-2.673 19.207c0 .613.438 1.191 1.043 1.191c.608 0 1.034-.439 1.034-1.055v-9.301h1.281v9.301c0 .615.375 1.123.98 1.123c.608 0 1.049-.646 1.049-1.26L20.9 23.66h1.218v6.497c0 .65 1.28.65 1.28 0v-6.352c0-1.323-1.03-2.615-2.562-2.615l-5.197-.012c-1.389 0-2.48 1.158-2.48 2.595v6.384c0 .65 1.279.65 1.279 0V23.66h1.138zm16.58-19.207a1.976 1.976 0 0 0 1.963-1.987c0-1.102-.887-1.994-1.963-1.994c-1.079 0-1.967.893-1.967 1.994c0 1.104.887 1.987 1.967 1.987m-2.668 19.207c0 .613.514 1.191 1.119 1.191c.613 0 1.127-.439 1.127-1.055v-9.301h.641v9.301c0 .615.605 1.123 1.214 1.123s1.166-.646 1.166-1.26l.068-16.312h.753v6.497c0 .65 1.919.65 1.919 0v-6.352c0-1.323-1.117-2.615-2.647-2.615l-5.151-.012c-1.392 0-2.441 1.158-2.441 2.595v6.384c0 .65 1.28.65 1.28 0V23.66h.961z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_POLICE: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M28.581 20.544c0 3.369-2.789 3.369-4.292 3.369h-1.874v-6.369h2.355c1.317 0 3.811 0 3.811 3m14.396-3.363c.278-3.428 1.271-6.574 3.023-9.458L39.281 1c-2.123 1.828-4.539 2.84-7.279 3.019a12.53 12.53 0 0 1-7.127-1.434c-2.301 1.146-4.671 1.625-7.142 1.434c-2.556-.229-4.862-1.135-6.928-2.741l-6.738 6.72q2.487 4.388 2.762 9.183c.086 1.472-.334 3.498-1.276 6.117c-.493 1.452-.866 2.712-1.12 3.764c-.235 1.045-.382 1.895-.431 2.531c-.035 2.791.748 5.311 2.353 7.55c1.254 1.635 3.322 3.44 6.194 5.415c3.142 1.6 5.574 2.639 7.277 3.081l1.412.656c.444.214.92.421 1.417.647c1.071.642 1.824 1.339 2.22 2.057c.486-.777 1.255-1.456 2.277-2.057a46 46 0 0 0 1.823-.828c.49-.215.855-.377 1.067-.476a19 19 0 0 1 1.417-.615c.583-.229 1.302-.51 2.161-.82c1.66-.589 2.868-1.144 3.636-1.646c2.785-1.975 4.821-3.75 6.117-5.339c1.662-2.249 2.469-4.78 2.432-7.626c-.098-1.274-.637-3.313-1.616-6.091c-.934-2.704-1.348-4.804-1.212-6.32m-12.35 9.21c-1.595 1.044-3.788 1.044-4.933 1.044h-3.145v8.606H17.82V13.965h6.713c3.12 0 5.729.201 7.541 2.41c1.131 1.406 1.322 3.003 1.322 4.138c-.002 2.571-1.061 4.741-2.769 5.878'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_POST_OFFICE: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M2.941 8c-2.941 0-1.47.779 0 1.974L25 26.763l22.059-16.737C48.531 8.831 50 8 47.059 8zM0 11.946v24.728C0 38.129 1.488 40 2.665 40h44.67C48.513 40 50 38.129 50 36.674V11.946L25 31.021z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_RESTAURANT: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M22 1.932V13h-2V2a1 1 0 0 0-2 0v11h-2V1.964c0-1.287-2-1.243-2-.033V13h-2V2.01c0-1.363-2-1.313-2-.054v14.472c0 2.087 2 3.463 4 3.463V46c0 4 6 4 6 0V19.892c2 0 4-1.662 4-3.227V1.964c0-1.275-2-1.226-2-.032M31 5v25h2v16c0 4 7 4 7 0V5c0-5-9-5-9 0'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_SAILING: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M47 49c-.952 0-1.884-.22-2.705-.597a6.6 6.6 0 0 0-2.794-.63c-.986 0-1.938.232-2.781.63a6.6 6.6 0 0 1-2.718.597c-.954 0-1.884-.22-2.708-.597a6.55 6.55 0 0 0-2.792-.63a6.6 6.6 0 0 0-2.785.63a6.6 6.6 0 0 1-2.712.597c-.964 0-1.884-.22-2.712-.597a6.6 6.6 0 0 0-2.787-.63c-.997 0-1.951.232-2.794.63a6.5 6.5 0 0 1-2.713.597c-.958 0-1.884-.22-2.71-.597a6.6 6.6 0 0 0-2.789-.63c-.992 0-1.945.232-2.789.63A6.5 6.5 0 0 1 3 49v-4.102c.964 0 1.884-.22 2.711-.597a6.7 6.7 0 0 1 2.789-.619a6.7 6.7 0 0 1 2.789.619a6.55 6.55 0 0 0 2.71.597c.965 0 1.89-.22 2.712-.597a6.7 6.7 0 0 1 2.794-.619c.99 0 1.944.232 2.787.619a6.55 6.55 0 0 0 2.712.597c.958 0 1.884-.22 2.712-.597a6.7 6.7 0 0 1 2.785-.619c.997 0 1.951.232 2.792.619a6.5 6.5 0 0 0 2.708.597c.962 0 1.884-.22 2.718-.597a6.7 6.7 0 0 1 2.781-.619c.999 0 1.951.232 2.794.619a6.5 6.5 0 0 0 2.705.597V49zM29 1v31H4.287zm3 7.119C32 11.58 47.847 21 46.693 32H32zM43.527 34H10v6.2c1 .1.846.211 1.187.377a7 7 0 0 0 2.762.585c.965 0 1.916-.22 2.738-.585a6.6 6.6 0 0 1 2.807-.63c.99 0 1.95.231 2.793.63a6.75 6.75 0 0 0 2.715.585c.958 0 1.885-.22 2.713-.585a6.6 6.6 0 0 1 2.786-.63a6.5 6.5 0 0 1 2.793.63a6.7 6.7 0 0 0 2.708.585c.187 0 .36-.044.536-.066l.045.022l.328-.055c.219-.033.437-.056.657-.11c1.97-.409 3.244-2.006 3.244-2.006L44.647 34z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_SPORTS: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M34.438 17.552c3.498 0 6.346-2.801 6.346-6.271S37.937 5 34.438 5c-3.512 0-6.365 2.812-6.365 6.281c0 3.47 2.854 6.271 6.365 6.271M49 32.857v-7.94L40.435 20.1c-1.451-.728-3.064-.975-4.676-.635c-.66.135-1.281.387-1.979.771c-.076.021-2.619 1.13-4.097 4.541L23.785 36.51s-5.811 1.113-8.243 1.577l-.595.351l-1.505-5.381c-.623-2.188 1.701-5.36 1.788-5.489c1.538-2.225 1.959-5.156 1.151-8.059c-.736-2.625-2.412-4.838-4.594-6.083c-1.707-.959-3.626-1.223-5.368-.749c-1.353.367-2.559 1.154-3.491 2.285l-.721 1.05C.953 18.195.664 20.931 1.389 23.57c.736 2.65 2.393 4.854 4.586 6.082l.525.275c.07.005 3.682 1.461 4.31 3.55c-.008.011.948 3.427 1.728 6.211l-.594.27l.116.077c-.176.269-.485.865-.463 1.475q-.001.292.053.576c.333 1.725 2.042 2.877 3.788 2.526l11.145-2.144s.948-.285 1.354-.571c.523-.367.917-1.137.917-1.137l2.929-5.823s2.019 9.41 2.058 9.584l-.465.479h15.203l-.381-2.203c0-.022-.479-2.111-.479-2.111c.016.015-1.304-5.862-2.313-10.462a393 393 0 0 0 3.146 1.782zm-38.313-4.826c-1.129.3-2.335.118-3.491-.519c-1.61-.9-2.854-2.575-3.387-4.596c-.568-2.014-.361-4.077.556-5.667l.512-.738c.604-.733 1.336-1.223 2.214-1.466c2.804-.753 5.892 1.541 6.89 5.124c.983 3.567-.489 7.107-3.294 7.862'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_SUBWAY: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='m50 50l-.015-25.059c0-13.781-11.186-24.946-24.967-24.946S.051 11.168.051 24.95l.201 25.085L6 50.021v-25.07C6 14.21 14.262 5.504 25 5.504c10.74 0 19 8.707 19 19.448V50zm-16.803-9.074l-.092-.168l.048-.062l.044-.062q1.291-.531 2.339-1.31c.698-.522 1.106-1.286 1.348-2.296c.027-.117.116-.389.116-.804V15.371a3.1 3.1 0 0 0-.387-1.556c-.296-.54-.637-1.023-1.09-1.452c-.439-.425-.921-.721-1.472-1.006c-.55-.282-1.064-.357-1.571-.357H17.558c-.476 0-.988.067-1.54.335c-.551.267-1.058.577-1.516.995a5.5 5.5 0 0 0-1.096 1.382A3 3 0 0 0 13 15.24v21.164c0 .353.054.728.228 1.11c.179.389.381.752.648 1.088c.268.348.549.661.862.941c.312.282.608.512.908.688q.217.094.777.271c.369.119.539.19.511.246L10.829 50h3.561l4.458-6H31.15l4.452 6h3.606zM20 13c0-.55.45-1 1-1h8c.55 0 1 .45 1 1v1c0 .55-.45 1-1 1h-8c-.55 0-1-.45-1-1zm-3.936 4.885c.133-.282.237-.538.444-.779c.211-.238.422-.58.703-.729s.54-.377.837-.377h13.857c.267 0 .532.215.801.328c.268.12.512.363.737.569c.222.207.31.472.448.709c.131.232.109.526.109.793v4.724c0 .27.013.521-.133.775c-.148.26-.298.484-.538.677c-.239.189-.466.238-.733.353c-.268.126-.514.072-.778.072H18.137c-.033 0-.107.093-.225.069l-.27-.039c-.503-.088-.812-.329-1.2-.775c-.385-.449-.442-.907-.442-1.443v-4.054c0-.297-.068-.589.064-.873m3.787 19.275c-.459.475-1.034.712-1.714.712q-1.025 0-1.673-.712c-.432-.474-.646-1.058-.646-1.739q.002-.936.669-1.624a2.2 2.2 0 0 1 1.65-.693c.68 0 1.254.219 1.714.643c.461.438.692 1.002.692 1.721q0 .982-.692 1.692m10.203 0c-.458-.474-.689-1.058-.689-1.739c0-.686.243-1.237.734-1.675a2.56 2.56 0 0 1 1.72-.643q1.019 0 1.666.693q.65.688.649 1.624c0 .682-.221 1.266-.671 1.739q-.666.712-1.693.712q-1.023.002-1.716-.711'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_TAXI: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='m45.699 24.145l-7.89-13.293c-.314-.584-1.072-.852-1.721-.852H29V4c0-1.1-.9-2-2-2h-5c-1.1 0-2 .9-2 2v6h-5.96c-.65 0-1.44.268-1.754.852L4.365 24.25C3.064 24.25 2 25.237 2 26.572v12.139C2 40.046 3.064 41 4.365 41H7v3.78C7 46.784 8.328 48 10.279 48h1.183C13.413 48 15 46.784 15 44.78V41h20v3.78c0 2.004 1.714 3.22 3.665 3.22h1.184C41.8 48 43 46.784 43 44.78V41h2.763c1.3 0 2.237-.954 2.237-2.289V26.572c0-1.335-1-2.427-2.301-2.427m-37.194 9.71c-1.633 0-2.958-1.358-2.958-3.034c0-1.677 1.324-3.035 2.958-3.035s2.957 1.358 2.957 3.035c0 1.676-1.323 3.034-2.957 3.034M10.279 24l5.384-9.377c.292-.598 1.063-.623 1.713-.623h15.376c.65 0 1.421.025 1.712.623L39.849 24zm31.343 9.855c-1.632 0-2.957-1.358-2.957-3.034c0-1.677 1.325-3.035 2.957-3.035c1.633 0 2.958 1.358 2.958 3.035c0 1.676-1.325 3.034-2.958 3.034'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_TOILET: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M6 47.5c0 1.233.768 2 2 2c1.235 0 2-.767 2-2V29h2v18.5c0 1.231.767 2 2 2s2-.767 2-2V16h1v11.314c0 2.395 3.006 2.395 3 0V15.161C20 12.515 18.094 11 15 11H7c-2.82 0-5 1.219-5 4.087V28c0 2 3 2 3 0V16h1z'/%3E%3Ccircle cx='10.875' cy='5.125' r='4.125' fill='{icon_color}'/%3E%3Ccircle cx='35.875' cy='5.125' r='4.125' fill='{icon_color}'/%3E%3Cpath fill='{icon_color}' d='m45.913 32.5l-5.909-16.237l-.034-.167c0-.237.199-.429.447-.429c.211 0 .388.141.435.329L44.869 26.5c.267.601 1.365 1 2.087 1c.965 0 1.065-1.895 1.044-2l-4.017-10.107C43.634 13.072 41.29 11 38.615 11H33.38c-2.675 0-5.192 2.072-5.542 4.393l-3.837 10.232c-.087.199 0 1.938 1.044 1.938c.811 0 1.89-.314 2.086-1.031l3.875-10.564a.455.455 0 0 1 .422-.292c.246 0 .445.188.445.424l-.027.151l-5.758 16.251c-.012.048 0 1.2 0 1.249c0 .346.836 1.25 1.198 1.25H31v12.595c0 1.04.916 1.905 2 1.905s2-.866 2-1.905V34.491c0-.283 2-.274 2 .009v13c0 1.04.917 2 2 2c1.086 0 2-.961 2-2V35h3.869c.362 0 1.044-.904 1.044-1.25c0-.08.029-1.181 0-1.25'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_TRAIN: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='m34.641 37.807l-.113-.216l.057-.081l.057-.081a13.4 13.4 0 0 0 2.861-1.604q1.28-.958 1.721-2.809l.215-.988V6.507c0-.616-.184-1.255-.547-1.905a7.3 7.3 0 0 0-1.365-1.777a7.8 7.8 0 0 0-1.824-1.311Q34.691.999 33.764 1H15.499q-.875-.002-1.885.487a7.8 7.8 0 0 0-1.854 1.257a7 7 0 0 0-1.39 1.713c-.364.645-.547 1.267-.547 1.89v25.901c0 .436.115.891.327 1.363q.33.71.818 1.331c.326.426.685.807 1.067 1.15s.753.627 1.118.844c.176.074.499.188.957.333q.674.216.624.321L7.258 48.936h4.361l5.457-7.909h15.055l5.451 7.909H42zM20.294 3.179c0-.183.087-.37.273-.575q.268-.297.545-.295h6.982c.07 0 .221.07.438.213q.323.219.324.436V5.63c0 .183-.092.351-.271.49c-.184.15-.35.226-.49.226H21.06l-.222-.173a2 2 0 0 1-.353-.301a.55.55 0 0 1-.191-.401zm-7.037 7.472c0-.363.086-.719.247-1.066c.162-.345.373-.66.627-.955c.256-.292.556-.521.898-.704a2.26 2.26 0 0 1 1.068-.274H33.06c.322 0 .65.076.977.214c.328.146.627.35.902.602c.274.252.489.532.655.822c.162.284.242.596.242.923v5.783c0 .328-.088.638-.27.95a3 3 0 0 1-.709.827a4 4 0 0 1-.928.564a2.25 2.25 0 0 1-.979.22H16.206l-.276-.049a1.7 1.7 0 0 1-.329-.113q-.922-.16-1.633-.982q-.711-.818-.711-1.797zm5.049 22.526c-.563.581-1.268.871-2.1.871q-1.255 0-2.05-.871c-.526-.58-.789-1.294-.789-2.131q0-1.144.821-1.986q.816-.85 2.018-.851c.832 0 1.536.27 2.1.789c.564.533.845 1.226.845 2.105q0 1.203-.845 2.074m12.489 0c-.562-.58-.848-1.294-.848-2.131c0-.838.299-1.515.9-2.048a3.12 3.12 0 0 1 2.104-.789c.83 0 1.516.285 2.043.851c.525.562.793 1.224.793 1.986c0 .837-.275 1.551-.82 2.131c-.549.581-1.236.871-2.076.871q-1.252 0-2.096-.871'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_TRANSIT_STATION: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M20.716 24H3.159c-.512 0-.933-.314-.933-.815l.032-.19l.935-6.006c.078-.424.459.011.917.011h15.657c.454 0 .838-.412.915.012l.936 6.399l.033-.038c0 .497-.424.627-.935.627m-.703 7.569c-.987 0-1.791-.781-1.791-1.75c0-.964.803-1.74 1.791-1.74c.982 0 1.785.776 1.785 1.74c0 .969-.802 1.75-1.785 1.75m-16.177 0c-.979 0-1.782-.781-1.782-1.75c0-.964.802-1.74 1.782-1.74c.993 0 1.794.776 1.794 1.74c0 .969-.801 1.75-1.794 1.75M6 12h11v3H6c-1 0-1-3 0-3m16.698 2.703c-.319-1.542-1.412-2.162-2.939-2.783c-1.524-.619-5.133-1.36-7.788-1.36c-2.666 0-6.255.742-7.779 1.36c-1.525.621-2.635 1.241-2.954 2.783L0 23.289V35h1.785c0 5 3.361 5 3.361 0h13.441c0 5 3.36 5 3.36 0H24V23.289zm22.061 20.391l-.08-.145l.04-.055l.04-.055a9.5 9.5 0 0 0 2.038-1.141c.607-.456.928-1.12 1.139-1.999c.021-.102.064-.34.064-.703V12.821c0-.439-.043-.894-.301-1.356c-.26-.471-.539-.892-.93-1.266c-.387-.37-.947-.685-1.429-.933c-.417-.214-1.34-.328-1.34-.355V9h.135H31v-.072c-1 .046-.756.15-1.102.318c-.48.234-.979.532-1.379.895c-.4.36-.801.769-1.06 1.22c-.259.459-.459.902-.459 1.346v18.446c0 .31.123.634.273.971c.158.337.372.652.604.947c.232.304.498.575.771.819c.271.245.542.447.802.602c.125.053.357.133.684.236c.318.103.47.16.446.211L25.258 43h3.106l3.886-6h10.722l3.882 6H50zM35.757 10h3.561c.783 0 1.425.216 1.425 1c0 .783-.642 1-1.425 1h-3.561c-.784 0-1.425-.217-1.425-1c0-.784.641-1 1.425-1M45 19.151A2.85 2.85 0 0 1 42.151 22H31.849A2.85 2.85 0 0 1 29 19.151v-2.303A2.85 2.85 0 0 1 31.849 14h10.303A2.85 2.85 0 0 1 45 16.849zM33.126 31.814c-.401.414-.903.62-1.495.62q-.895 0-1.461-.62c-.374-.413-.562-.922-.562-1.518q0-.815.585-1.415a1.92 1.92 0 0 1 1.438-.605c.592 0 1.094.192 1.495.562c.401.38.602.873.602 1.5q0 .856-.602 1.476m8.895 0a2.1 2.1 0 0 1-.604-1.518c0-.597.213-1.079.642-1.459a2.23 2.23 0 0 1 1.498-.562c.591 0 1.079.203 1.455.605q.563.6.564 1.415q-.001.895-.584 1.518c-.391.414-.881.62-1.479.62q-.892.003-1.492-.619'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_UNIVERSITY: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M24.999 27.381c-5.406 0-9.999 1.572-12.999 4.036V36h26v-4.583c-3-2.464-7.594-4.036-13.001-4.036m23.871-2.352L24.936 14L1.012 25.029L5 26.854v2.807c-1 .207-1.003.731-1.003 1.354c0 .368.122.799.354 1.057L2.983 35h4.88l-1.356-2.93c.228-.258.415-.638.415-1.006c0-.622-.922-1.197-.922-1.404v-2.337l5 2.246v-.199c3-2.609 8.271-4.265 13.998-4.265C30.727 25.105 36 26.761 39 29.37v.199z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_VET: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M18.48 18.875c2.33-.396 4.058-2.518 4.321-5.053c.267-2.578.869-12.938-3.02-12.279c-10.088 1.711-9.38 18.702-1.301 17.332m13.273 0c8.077 1.37 8.785-15.621-1.303-17.333c-3.888-.659-3.287 9.701-3.021 12.279c.264 2.536 1.994 4.658 4.324 5.054M14.336 26.88c0-1.348-.481-2.57-1.256-3.459c-1.275-1.666-5.328-5.035-6.323-4.172c-2.077 1.806-2.01 6.251-.759 9.481c.643 1.796 2.196 3.059 4.011 3.059c2.389 0 4.327-2.198 4.327-4.909m29.137-7.631c-.993-.863-5.046 2.506-6.321 4.172c-.775.889-1.257 2.111-1.257 3.459c0 2.711 1.94 4.909 4.327 4.909c1.816 0 3.37-1.263 4.013-3.059c1.248-3.23 1.317-7.675-.762-9.481m-8.136 15.277c-3.676-1.833-3.562-5.363-4.398-8.584c-.665-2.569-3.02-4.469-5.823-4.469a6.01 6.01 0 0 0-5.779 4.312c-.895 3.082-.356 6.67-4.363 8.717c-3.255 1.061-4.573 2.609-4.573 6.27c0 2.974 2.553 6.158 5.848 6.554c3.676.554 6.544-.17 8.867-1.494c2.323 1.324 5.189 2.047 8.871 1.494c3.293-.396 5.847-3.568 5.847-6.554c-.001-3.741-1.235-5.135-4.497-6.246M31 39h-3.811l.005 4h-4.156l.006-4H19v-4h4.045l-.006-4h4.156l-.005 4H31z'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_WHEELCHAIR: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='M16.783 9c2.219 0 4-1.805 4-4c0-2.219-1.781-4-4-4c-2.206 0-4 1.782-4 4c0 2.195 1.794 4 4 4m2.824 36.675c-6.812 0-12.336-5.601-12.336-12.537c0-3.797 1.689-7.185 4.324-9.489l-.219-3.922C6.964 22.529 4 27.458 4 33.138C4 41.89 10.983 49 19.607 49C25.953 49 31.562 44.529 34 39l-2.376-3.272c-1.174 5.665-6.09 9.947-12.017 9.947M44 38h-2l-8-11c-.433-.761-2-3-4-3h-9v-4h8c1.036 0 2.154-.441 2.154-1.506C31.154 17.437 30.065 17 29 17h-8v-4c-.147-2.218-2-3-3.99-2.954C15 10.092 14 11 14 13v14c.19 2.246 1.807 3 4 3h12l7 9c.451.746 2 3 2 3h5c1.032 0 2-.938 2-2c0-1.057-.936-2-2-2'/%3E%3C/svg%3E",  # noqa
    MARKER_ICON_ZOO: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48px' height='48px' viewBox='0 0 50 50'%3E%3Cpath fill='{icon_color}' d='m45.928 28.949l-.109-.294c-.342-.922-.765-2.068-1.849-2.717c-.755-.452-1.633-.609-2.407-.747a10 10 0 0 1-1.098-.238l-.284-.1l-.045-.015c-3.108-2.496-9.401-2.564-13.321-6.094C21.197 13.688 16.688 8.604 11.617 1L5.281 6.07c-.44.352-1.28.634-1.28 1.901c0 .633.644.73 1.403.495l3.574-1.129L19 21.281v7.606c0 1.76-.029 3.362 1.464 4.272L16.7 49h2.535l2.382-7.522L24 37.758V49h3V36.492s-.035-2.535 2.5-2.535l2.5 2.535V49h2V39l5.516 10h2.535C40.783 45 39 45.363 39 41.561v-2.535c0-2.658 3-5.07 3-7.605v-2.533c0-.602-.078-1.135-.215-1.617c.442.09.848.199 1.157.385c.479.287.744 1.003 1 1.695l.116.312a1 1 0 0 0 1.29.578l.001-.001a1 1 0 0 0 .579-1.291'/%3E%3C/svg%3E",  # noqa
}

#: The default map tiles.
TILES_DEFAULT = "Default (OpenStreetMap Mapnik)"
#: Topographical map tiles.
TILES_TOPOGRAPHICAL = "Topographical (OpenTopoMap)"
#: Artistic map tiles.
TILES_ARTISTIC = "Artistic (Stamen Watercolor)"
#: High contrast map tiles.
TILES_HIGH_CONTRAST = "High contrast (Stamen Toner)"
#: Greyscale map tiles.
TILES_GREYSCALE = "Greyscale (TopPlusOpen Grey)"
#: Satellite map tiles.
TILES_SATELLITE = "Satellite (ESRI satellite)"

#: Maps tile names to their URLs and attributions.
_TILES = {
    TILES_DEFAULT: {
        "url": "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        "attribution": '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    },
    TILES_TOPOGRAPHICAL: {
        "url": "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
        "attribution": 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
    },
    TILES_ARTISTIC: {
        "url": "https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg",
        "attribution": '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',
    },
    TILES_HIGH_CONTRAST: {
        "url": "https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png",
        "attribution": '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    },
    TILES_GREYSCALE: {
        "url": "http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web_grau/default/WEBMERCATOR/{z}/{y}/{x}.png",
        "attribution": 'Map data: &copy; <a href="http://www.govdata.de/dl-de/by-2-0">dl-de/by-2-0</a>',
    },
    TILES_SATELLITE: {
        "url": "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        "attribution": "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
    },
}


class Map(Widget):
    """
    Represents a map to display on the user interface.
    """

    #: Marker icon remaps for convenient and easy access.
    MARKER_ICON_DEFAULT = MARKER_ICON_DEFAULT
    MARKER_ICON_AIRPORT = MARKER_ICON_AIRPORT
    MARKER_ICON_AMUSEMENTS = MARKER_ICON_AMUSEMENTS
    MARKER_ICON_BANK = MARKER_ICON_BANK
    MARKER_ICON_SALON = MARKER_ICON_SALON
    MARKER_ICON_BOOKS = MARKER_ICON_BOOKS
    MARKER_ICON_BUS_STOP = MARKER_ICON_BUS_STOP
    MARKER_ICON_CAFE = MARKER_ICON_CAFE
    MARKER_ICON_CAMPING = MARKER_ICON_CAMPING
    MARKER_ICON_CAR_HIRE = MARKER_ICON_CAR_HIRE
    MARKER_ICON_CAR_REPAIR = MARKER_ICON_CAR_REPAIR
    MARKER_ICON_CONVENIENCE_STORE = MARKER_ICON_CONVENIENCE_STORE
    MARKER_ICON_CROSSHAIRS = MARKER_ICON_CROSSHAIRS
    MARKER_ICON_DENTIST = MARKER_ICON_DENTIST
    MARKER_ICON_DOCTOR = MARKER_ICON_DOCTOR
    MARKER_ICON_ELECTRICAL = MARKER_ICON_ELECTRICAL
    MARKER_ICON_FLAG = MARKER_ICON_FLAG
    MARKER_ICON_FIRE_STATION = MARKER_ICON_FIRE_STATION
    MARKER_ICON_FLOWER = MARKER_ICON_FLOWER
    MARKER_ICON_FAST_FOOD = MARKER_ICON_FAST_FOOD
    MARKER_ICON_FUEL = MARKER_ICON_FUEL
    MARKER_ICON_HOSPITAL = MARKER_ICON_HOSPITAL
    MARKER_ICON_LAUNDRY = MARKER_ICON_LAUNDRY
    MARKER_ICON_LAW = MARKER_ICON_LAW
    MARKER_ICON_HOTEL = MARKER_ICON_HOTEL
    MARKER_ICON_MOVIE = MARKER_ICON_MOVIE
    MARKER_ICON_MUSEUM = MARKER_ICON_MUSEUM
    MARKER_ICON_NIGHTCLUB = MARKER_ICON_NIGHTCLUB
    MARKER_ICON_PICNIC = MARKER_ICON_PICNIC
    MARKER_ICON_PARKING = MARKER_ICON_PARKING
    MARKER_ICON_PHARMACY = MARKER_ICON_PHARMACY
    MARKER_ICON_PHOTO = MARKER_ICON_PHOTO
    MARKER_ICON_PLACE_OF_WORSHIP = MARKER_ICON_PLACE_OF_WORSHIP
    MARKER_ICON_POLICE = MARKER_ICON_POLICE
    MARKER_ICON_POST_OFFICE = MARKER_ICON_POST_OFFICE
    MARKER_ICON_RESTAURANT = MARKER_ICON_RESTAURANT
    MARKER_ICON_SAILING = MARKER_ICON_SAILING
    MARKER_ICON_SPORTS = MARKER_ICON_SPORTS
    MARKER_ICON_SUBWAY = MARKER_ICON_SUBWAY
    MARKER_ICON_TAXI = MARKER_ICON_TAXI
    MARKER_ICON_TOILET = MARKER_ICON_TOILET
    MARKER_ICON_TRAIN = MARKER_ICON_TRAIN
    MARKER_ICON_TRANSIT_STATION = MARKER_ICON_TRANSIT_STATION
    MARKER_ICON_UNIVERSITY = MARKER_ICON_UNIVERSITY
    MARKER_ICON_VET = MARKER_ICON_VET
    MARKER_ICON_WHEELCHAIR = MARKER_ICON_WHEELCHAIR
    MARKER_ICON_ZOO = MARKER_ICON_ZOO

    #: Default map tiles.
    TILES_DEFAULT = TILES_DEFAULT
    #: Topographical map tiles.
    TILES_TOPOGRAPHICAL = TILES_TOPOGRAPHICAL
    #: Artistic map tiles.
    TILES_ARTISTIC = TILES_ARTISTIC
    #: High contrast map tiles.
    TILES_HIGH_CONTRAST = TILES_HIGH_CONTRAST
    #: Greyscale map tiles.
    TILES_GREYSCALE = TILES_GREYSCALE
    #: Satellite map tiles.
    TILES_SATELLITE = TILES_SATELLITE

    center_latitude = FloatProperty(
        _("The latitude of the center of the map."),
        required=True,
        default_value=51.505,
    )

    center_longitude = FloatProperty(
        _("The longitude of the center of the map."),
        required=True,
        default_value=-0.09,
    )

    zoom_level = IntegerProperty(
        _("The zoom level of the map."),
        required=True,
        default_value=12,
    )

    height = TextProperty(
        _("The height of the map."),
        required=True,
        default_value="280px",
    )

    markers = ListProperty(
        _("The markers to display on the map."),
        required=False,
        default_value=[],
    )

    tile_set = ChoiceProperty(
        _("The set of tiles to use for the map."),
        required=True,
        default_value=TILES_DEFAULT,
        choices=_TILES.keys(),
    )

    marker_added = Event(
        _("Sent when a marker is added to the map."),
        latitude=_("The latitude of the new marker."),
        longitude=_("The longitude of the new marker."),
        popup_content=_("The content to display when the marker is clicked."),
        icon=_("The icon to use for the marker."),
    )

    height_changed = Event(
        _("Sent when the height of the map is changed."),
        height=_("The new height of the map."),
    )

    center_changed = Event(
        _("Sent when the center of the map is changed."),
        latitude=_("The new latitude of the center of the map."),
        longitude=_("The new longitude of the center of the map."),
    )

    zoom_level_changed = Event(
        _("Sent when the zoom level of the map is changed."),
        zoom_level=_("The new zoom level of the map."),
    )

    point_selected = Event(
        _("Sent when a point on the map is selected."),
        latitude=_("The latitude of the selected point."),
        longitude=_("The longitude of the selected point."),
    )

    tiles_changed = Event(
        _("Sent when the tiles used by the map are changed."),
        tile_set=_("The new set of tiles used by the map."),
    )

    @classmethod
    def icon(cls):
        return '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256"><path fill="currentColor" d="M112 80a16 16 0 1 1 16 16a16 16 0 0 1-16-16m-48 0a64 64 0 0 1 128 0c0 59.95-57.58 93.54-60 94.95a8 8 0 0 1-7.94 0C121.58 173.54 64 140 64 80m16 0c0 42.2 35.84 70.21 48 78.5c12.15-8.28 48-36.3 48-78.5a48 48 0 0 0-96 0m122.77 67.63a8 8 0 0 0-5.54 15C213.74 168.74 224 176.92 224 184c0 13.36-36.52 32-96 32s-96-18.64-96-32c0-7.08 10.26-15.26 26.77-21.36a8 8 0 0 0-5.54-15C29.22 156.49 16 169.41 16 184c0 31.18 57.71 48 112 48s112-16.82 112-48c0-14.59-13.22-27.51-37.23-36.37"/></svg>'  # noqa

    def _recenter(self):
        # Late binding of leaflet to ensure it's available.
        from invent import leaflet as L

        self.map.setView(
            L.latLng(self.center_latitude, self.center_longitude),
            self.zoom_level,
        )
        self.publish(
            "center_changed",
            latitude=self.center_latitude,
            longitude=self.center_longitude,
        )

    def on_center_latitude_changed(self):
        self._recenter()

    def on_center_longitude_changed(self):
        self._recenter()

    def on_zoom_level_changed(self):
        self.map.setZoom(self.zoom_level)
        self.publish("zoom_level_changed", zoom_level=self.zoom_level)

    def on_height_changed(self):
        self.element.style["height"] = self.height
        self.publish("height_changed", height=self.height)

    def on_markers_changed(self):
        for marker in self.markers:
            if not self.map.hasLayer(marker.marker):
                self.map.addLayer(marker.marker)
                self.publish(
                    "marker_added",
                    latitude=marker.latitude,
                    longitude=marker.longitude,
                    popup_content=marker.popup_content,
                    icon=marker.icon,
                )

    def on_tile_set_changed(self):
        t = _TILES[self.tile_set]
        layer = self.L.tileLayer(
            t["url"], {"attribution": t["attribution"]}
        ).addTo(self.map)
        self.publish("tiles_changed", tile_set=self.tile_set)

    def _select_point(self, event):
        self.publish(
            "point_selected",
            latitude=event.latlng.lat,
            longitude=event.latlng.lng,
        )

    def render(self):
        # Late binding of leaflet to ensure it's available.
        from invent import leaflet as L

        self.L = L  # escape hatch for advanced users.

        element = div(id=self.id)
        element.classes.add("invent-map-widget")

        self.map = L.map(element._dom_element).setView(
            L.latLng(self.center_latitude, self.center_longitude),
            self.zoom_level,
        )
        # Ensure map clicks are handled properly.
        self.map.on("click", self._select_point)
        # Ensures the map is properly rendered once added to the DOM.
        window.requestAnimationFrame(
            create_proxy(lambda *args: self.map.invalidateSize())
        )
        return element

    class Marker:
        """
        An inner class to represent a marker on a map.

        This must have a longitude and latitude, and can may also have content
        for the popup that appears when the marker is clicked. The content may
        be a Markdown string, or Invent widgets that will be rendered in the
        popup. The icon should be an image (use the built-in icons provided as
        MARKER_ICON_* constants or a URL to an image). The icon color should be
        a hex / valid HTML color code.
        """

        def __init__(
            self,
            latitude=51.4768325,
            longitude=0.0,
            popup_content=None,
            icon=MARKER_ICON_DEFAULT,
            icon_color="#F00",
        ):
            # Late binding of leaflet to ensure it's available.
            from invent import leaflet as L

            self.latitude = latitude
            self.longitude = longitude
            self.popup_content = popup_content
            # Ensure the icon is a valid built-in image.
            if icon in MARKER_ICONS:
                icon = MARKER_ICONS[icon]
            # Make the color of the icon URL safe.
            icon_color = icon_color.replace("#", "%23")
            # Replace the color in the icon URL.
            icon = icon.format(icon_color=icon_color)
            # Create the icon for the marker.
            self.icon = L.icon(
                iconUrl=icon,
                iconSize=L.point(50, 50),
                iconAnchor=L.point(25, 50),
                popupAnchor=L.point(0, -50),
            )
            # Create the marker.
            self.marker = L.marker(L.latLng(self.latitude, self.longitude))
            self.marker.setIcon(self.icon)
            # Add the popup content if it exists, checking if it's a string or
            # a widget etc...
            if self.popup_content:
                if isinstance(self.popup_content, str):
                    self.popup_content = from_markdown(self.popup_content)
                else:
                    self.popup_content = self.popup_content.render().outerHTML
                self.marker.bindPopup(self.popup_content)
